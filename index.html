<!doctype html>
<!--[if lt IE 7]>      <html ng-app="kalitiri" class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html ng-app="kalitiri" class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html ng-app="kalitiri" class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html ng-app="kalitiri" class="no-js" lang=""> <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>Kalitiri</title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="apple-touch-icon" href="apple-touch-icon.png">

		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/bootstrap-theme.min.css">
		<link rel="stylesheet" href="css/main.css">
		<script src="js/vendor/angular.1.3.14.min.js"></script>
		<!-- -->
		<link rel="stylesheet/less" type="text/css" href="css/main.less" />
		<script type="text/javascript"></script>

		<script src="js/vendor/less.2.3.1.min.js"></script>
		<!-- -->

		<script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
	</head>
	<body ng-controller="MainCtrl" ng-cloak>
		<div class="container">
			<nav class="navbar navbar-inverse">
				<a class="navbar-brand" tabindex="-1" href="#">Kalitiri</a>
				<span class="pull-right">
					<a class="btn glyphicon glyphicon-off" ng-click="reset()"></a>
				</span>
			</nav>
			<div class="row">
				<players class="col-xs-12 col-md-3 col-sm-4">
					<table class="table table-striped">
						<tr>
							<td colspan="2">
								<form ng-submit="players.add(this)" class="has-feedback">
									<input ng-model="player" ng-blur="player?players.add(this):null" required onclick="this.select()" plain class="form-control" placeholder="Add {{players.length + 1 + (['st','nd','rd'][players.length % 10] || 'th')}} Player" />
									<button type="reset" class="glyphicon glyphicon-remove"></button>
								</form>
							</td>
						</tr>
						<tr>
							<td class="text-right">Decks:</td>
							<td><input ng-model="decks" type="number" min="1" onclick="this.select()" plain />( -{{cards.extra}} )</td>
						</tr>
						<tr>
							<td class="text-right">Hands:</td>
						  	<td>{{cards.hands}}</td>
						</tr>
					</table>
				</players>
				<div class="col-xs-12 col-md-9 col-sm-8">
					<scoreboard>
						<player ng-repeat="player in players track by $index">
							<score ng-style="{height:'{{player.score}}px'}"></score>
							<form>
								<input ng-model="player.name" onclick="this.select()" plain class="form-control" />
								<button class="glyphicon glyphicon-remove" ng-click="players.remove(this)"></button>
							</form>
						</player>
					</scoreboard>
					<deck><card ng-repeat="card in cards.stack.concat(cards.extras)" card="{{card.sym}}{{card.symbol}}" color="{{card.color}}" ng-disabled="{{card.extra}}"></card></deck>
				</div>
			</div>
			<div class="row">
				<dashboard class="col-xs-12 col-md-3 col-sm-4">
					<table class="table table-striped">
						<tr>
							<td colspan="2">
								<h4 class="text-center">{{date.toLocaleDateString()}}</h4>
							</td>
						</tr>
					</table>
				</dashboard>
			</div>
		</div>
		<script src="js/vendor/jquery-1.11.2.min.js"></script>

		<script src="js/vendor/bootstrap.min.js"></script>

		<script src="js/plugins.js"></script>
		<script src="js/main.js"></script>
		<script type="text/javascript">
			;( function ($, w, d, undefined) {
				angular
					.module('kalitiri', [])
					.controller('MainCtrl', function($scope) {
						// Players

						$scope.players  = 	(function() {
												return angular.extend(angular.fromJson(localStorage.kalitiri_Players || '[]'), {
													add   : function(p) {
														if (!isNaN(players = parseInt(p.player))) {
															this.length = 0;
															while(players) { this.push({ name: '', score: 0 }); players--; }
														}
														else this.push({ name: p.player, score: 0 });
														p.player = '';
													},
													remove: function(p) { this.splice(this.indexOf(p.player), 1); }
												});
											})();

						// Cards

						var suits 		= 	[
												{ 'symbol':'♠', 'suit': 'spades',   'color':'black' },
												{ 'symbol':'♥', 'suit': 'hearts',   'color':'red'   },
												{ 'symbol':'♦', 'suit': 'diamonds', 'color':'red'   },
												{ 'symbol':'♣', 'suit': 'clubs',    'color':'black' }
											];
						suits.cards 	= 	13;

						$scope.log 		= 	function(s) { console.log(s); };
						$scope.decks    =   parseInt(localStorage.kalitiri_Decks || 1);
						$scope.cards    =   function() {
												var total = suits.cards * suits.length * ($scope.decks || 1),
													stack = total - ($scope.cards.extra = total % ($scope.players.length || 1));
												$scope.cards.hands = stack / ($scope.players.length || 1);

												$scope.cards.stack  = [];
												$scope.cards.extras = [];
												for(var weight = suits.cards + 1; weight > 1; weight--)
												for(var suit = 0, sym = ({ '11':'J','12':'Q','13':'K','14':'A' }[weight] || weight); suit < suits.length; suit++)
												for(var deck = 0; deck < $scope.decks; deck++) {
													$scope.cards[(inStack = $scope.cards.stack.length < stack) ? 'stack' : 'extras']
														.push(angular.extend({
															weight : weight%14 || 1,
															sym    : sym,
															extra  : !(inStack)
														}, 	suits[suit]));
												}
											};
						$scope.shuffle 	=	function() { $scope.cards.stack.sort(function() { return 0.5 - Math.random(); }); };
						$scope.reset 	=	function() {
												delete localStorage.kalitiri_Players;
												delete localStorage.kalitiri_Decks;
												location.reload();
											};

						// Kalitiri

						$scope.date 	=	new Date();
						$scope.points	=	function() {
												$scope.cards.stack.reduce(function() {});
											}

						$scope.$watch('[players, decks]', function (newVal, oldVal, scope) {
						    angular.extend(localStorage, { kalitiri_Players  : angular.toJson(newVal[0]), kalitiri_Decks : newVal[1] });
						    $scope.cards();
						}, true);
						$scope.cards();
					});
			})(jQuery,window,document);
		 </script>
	</body>
</html>
